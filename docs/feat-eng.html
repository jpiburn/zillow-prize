<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>An Example Predictive Modeling Workflow Using The Zillow Prize Dataset</title>
  <meta name="description" content="This is to document an example workflow and predictive modeling process using the Kaggle Zillow competition as an example.">
  <meta name="generator" content="bookdown 0.7 and GitBook 2.6.7">

  <meta property="og:title" content="An Example Predictive Modeling Workflow Using The Zillow Prize Dataset" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This is to document an example workflow and predictive modeling process using the Kaggle Zillow competition as an example." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="An Example Predictive Modeling Workflow Using The Zillow Prize Dataset" />
  
  <meta name="twitter:description" content="This is to document an example workflow and predictive modeling process using the Kaggle Zillow competition as an example." />
  

<meta name="author" content="Jesse Piburn">


<meta name="date" content="2018-07-21">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="eda.html">
<link rel="next" href="feature-selection.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />







<script src="libs/htmlwidgets-1.2/htmlwidgets.js"></script>
<link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-1.3.1/leaflet.js"></script>
<link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
<script src="libs/Proj4Leaflet-1.0.1/proj4-compressed.js"></script>
<script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
<link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-binding-2.0.1/leaflet.js"></script>
<script src="libs/leaflet-providers-1.1.17/leaflet-providers.js"></script>
<script src="libs/leaflet-providers-plugin-2.0.1/leaflet-providers-plugin.js"></script>
<script src="libs/lfx-heat-0.1.0/lfx-heat-prod.js"></script>
<script src="libs/lfx-heat-0.1.0/lfx-heat-bindings.js"></script>
<script src="libs/datatables-binding-0.2/datatables.js"></script>
<link href="libs/dt-core-1.10.12/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="libs/dt-core-1.10.12/css/jquery.dataTables.extra.css" rel="stylesheet" />
<script src="libs/dt-core-1.10.12/js/jquery.dataTables.min.js"></script>
<link href="libs/dt-ext-fixedcolumns-1.10.12/css/fixedColumns.dataTables.min.css" rel="stylesheet" />
<script src="libs/dt-ext-fixedcolumns-1.10.12/js/dataTables.fixedColumns.min.js"></script>
<script src="libs/plotly-binding-4.7.1/plotly.js"></script>
<script src="libs/typedarray-0.1/typedarray.min.js"></script>
<link href="libs/crosstalk-1.0.0/css/crosstalk.css" rel="stylesheet" />
<script src="libs/crosstalk-1.0.0/js/crosstalk.min.js"></script>
<link href="libs/plotlyjs-1.29.2/plotly-htmlwidgets.css" rel="stylesheet" />
<script src="libs/plotlyjs-1.29.2/plotly-latest.min.js"></script>


<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Predictive Modeling Workflow</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Welcome</a></li>
<li class="chapter" data-level="1" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>1</b> Introduction</a><ul>
<li class="chapter" data-level="1.1" data-path="intro.html"><a href="intro.html#problem"><i class="fa fa-check"></i><b>1.1</b> Problem</a></li>
<li class="chapter" data-level="1.2" data-path="intro.html"><a href="intro.html#evaluation"><i class="fa fa-check"></i><b>1.2</b> Evaluation</a></li>
<li class="chapter" data-level="1.3" data-path="intro.html"><a href="intro.html#initital-thoughts"><i class="fa fa-check"></i><b>1.3</b> Initital Thoughts</a></li>
<li class="chapter" data-level="1.4" data-path="intro.html"><a href="intro.html#note-on-using-external-features"><i class="fa fa-check"></i><b>1.4</b> Note on Using External Features</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="preprocessing.html"><a href="preprocessing.html"><i class="fa fa-check"></i><b>2</b> PreProcessing</a><ul>
<li class="chapter" data-level="2.1" data-path="preprocessing.html"><a href="preprocessing.html#the-raw-data"><i class="fa fa-check"></i><b>2.1</b> The Raw Data</a><ul>
<li class="chapter" data-level="2.1.1" data-path="preprocessing.html"><a href="preprocessing.html#saving-raw-data-using-feather"><i class="fa fa-check"></i><b>2.1.1</b> Saving Raw Data Using <code>feather</code></a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="preprocessing.html"><a href="preprocessing.html#renaming-variables"><i class="fa fa-check"></i><b>2.2</b> Renaming Variables</a><ul>
<li class="chapter" data-level="2.2.1" data-path="preprocessing.html"><a href="preprocessing.html#renaming-properties-features"><i class="fa fa-check"></i><b>2.2.1</b> Renaming <code>properties</code> Features</a></li>
<li class="chapter" data-level="2.2.2" data-path="preprocessing.html"><a href="preprocessing.html#renaming-train-features"><i class="fa fa-check"></i><b>2.2.2</b> renaming <code>train</code> features</a></li>
<li class="chapter" data-level="2.2.3" data-path="preprocessing.html"><a href="preprocessing.html#basic-transformations"><i class="fa fa-check"></i><b>2.2.3</b> Basic Transformations</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="preprocessing.html"><a href="preprocessing.html#extracting-geographic-information"><i class="fa fa-check"></i><b>2.3</b> Extracting Geographic Information</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="eda.html"><a href="eda.html"><i class="fa fa-check"></i><b>3</b> Exploratory Analysis</a><ul>
<li class="chapter" data-level="3.1" data-path="eda.html"><a href="eda.html#response-variable"><i class="fa fa-check"></i><b>3.1</b> Response Variable</a><ul>
<li class="chapter" data-level="3.1.1" data-path="eda.html"><a href="eda.html#transactions-over-time"><i class="fa fa-check"></i><b>3.1.1</b> Transactions Over Time</a></li>
<li class="chapter" data-level="3.1.2" data-path="eda.html"><a href="eda.html#spatial-distribution-of-log_error"><i class="fa fa-check"></i><b>3.1.2</b> Spatial Distribution of <code>log_error</code></a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="eda.html"><a href="eda.html#predictor-variables"><i class="fa fa-check"></i><b>3.2</b> Predictor Variables</a><ul>
<li class="chapter" data-level="3.2.1" data-path="eda.html"><a href="eda.html#missingness"><i class="fa fa-check"></i><b>3.2.1</b> Missingness</a></li>
<li class="chapter" data-level="3.2.2" data-path="eda.html"><a href="eda.html#numeric-features"><i class="fa fa-check"></i><b>3.2.2</b> Numeric Features</a></li>
<li class="chapter" data-level="3.2.3" data-path="eda.html"><a href="eda.html#numeric-outliers"><i class="fa fa-check"></i><b>3.2.3</b> Numeric Outliers</a></li>
<li class="chapter" data-level="3.2.4" data-path="eda.html"><a href="eda.html#categorical-features"><i class="fa fa-check"></i><b>3.2.4</b> Categorical Features</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="eda.html"><a href="eda.html#exploring-log_error-a-little-more"><i class="fa fa-check"></i><b>3.3</b> Exploring <code>log_error</code> A little More</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="feat-eng.html"><a href="feat-eng.html"><i class="fa fa-check"></i><b>4</b> Feature Engineering</a><ul>
<li class="chapter" data-level="4.1" data-path="feat-eng.html"><a href="feat-eng.html#creating-new-features"><i class="fa fa-check"></i><b>4.1</b> Creating New Features</a><ul>
<li class="chapter" data-level="4.1.1" data-path="feat-eng.html"><a href="feat-eng.html#internal-features"><i class="fa fa-check"></i><b>4.1.1</b> Internal Features</a></li>
<li class="chapter" data-level="4.1.2" data-path="feat-eng.html"><a href="feat-eng.html#external-features"><i class="fa fa-check"></i><b>4.1.2</b> External Features</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="feat-eng.html"><a href="feat-eng.html#handling-missing-data"><i class="fa fa-check"></i><b>4.2</b> Handling Missing Data</a></li>
<li class="chapter" data-level="4.3" data-path="feat-eng.html"><a href="feat-eng.html#feature-transformation"><i class="fa fa-check"></i><b>4.3</b> Feature Transformation</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="feature-selection.html"><a href="feature-selection.html"><i class="fa fa-check"></i><b>5</b> Feature Selection</a><ul>
<li class="chapter" data-level="5.1" data-path="feature-selection.html"><a href="feature-selection.html#generate-importance-helper-function"><i class="fa fa-check"></i><b>5.1</b> Generate Importance Helper Function</a></li>
<li class="chapter" data-level="5.2" data-path="feature-selection.html"><a href="feature-selection.html#v-fold-cross-validation-resampling"><i class="fa fa-check"></i><b>5.2</b> V-Fold Cross Validation Resampling</a></li>
<li class="chapter" data-level="5.3" data-path="feature-selection.html"><a href="feature-selection.html#inspect-importance-results"><i class="fa fa-check"></i><b>5.3</b> Inspect Importance Results</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="modeling.html"><a href="modeling.html"><i class="fa fa-check"></i><b>6</b> Modeling</a><ul>
<li class="chapter" data-level="6.1" data-path="modeling.html"><a href="modeling.html#xgboost"><i class="fa fa-check"></i><b>6.1</b> XGBoost</a></li>
<li class="chapter" data-level="6.2" data-path="modeling.html"><a href="modeling.html#our-recipe-for-success"><i class="fa fa-check"></i><b>6.2</b> Our Recipe for Success</a></li>
<li class="chapter" data-level="6.3" data-path="modeling.html"><a href="modeling.html#base-line-model"><i class="fa fa-check"></i><b>6.3</b> Base Line Model</a><ul>
<li class="chapter" data-level="6.3.1" data-path="modeling.html"><a href="modeling.html#making-predictions-with-base-line-model"><i class="fa fa-check"></i><b>6.3.1</b> Making Predictions with Base Line Model</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="modeling.html"><a href="modeling.html#hyperparameter-optimization"><i class="fa fa-check"></i><b>6.4</b> Hyperparameter Optimization</a><ul>
<li class="chapter" data-level="6.4.1" data-path="modeling.html"><a href="modeling.html#creating-our-scoring-function"><i class="fa fa-check"></i><b>6.4.1</b> Creating Our Scoring Function</a></li>
<li class="chapter" data-level="6.4.2" data-path="modeling.html"><a href="modeling.html#parameter-search-space"><i class="fa fa-check"></i><b>6.4.2</b> Parameter Search Space</a></li>
<li class="chapter" data-level="6.4.3" data-path="modeling.html"><a href="modeling.html#fold-cross-validation"><i class="fa fa-check"></i><b>6.4.3</b> 5-fold Cross Validation</a></li>
<li class="chapter" data-level="6.4.4" data-path="modeling.html"><a href="modeling.html#random-forest-search-of-parameter-space"><i class="fa fa-check"></i><b>6.4.4</b> Random Forest Search of Parameter Space</a></li>
<li class="chapter" data-level="6.4.5" data-path="modeling.html"><a href="modeling.html#exploring-parameter-space"><i class="fa fa-check"></i><b>6.4.5</b> Exploring Parameter Space</a></li>
</ul></li>
<li class="chapter" data-level="6.5" data-path="modeling.html"><a href="modeling.html#tuned-model"><i class="fa fa-check"></i><b>6.5</b> Tuned Model</a><ul>
<li class="chapter" data-level="6.5.1" data-path="modeling.html"><a href="modeling.html#making-predictions-with-tuned-model"><i class="fa fa-check"></i><b>6.5.1</b> Making Predictions with Tuned Model</a></li>
</ul></li>
<li class="chapter" data-level="6.6" data-path="modeling.html"><a href="modeling.html#model-comparison"><i class="fa fa-check"></i><b>6.6</b> Model Comparison</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="summary.html"><a href="summary.html"><i class="fa fa-check"></i><b>7</b> Summary</a><ul>
<li class="chapter" data-level="7.1" data-path="summary.html"><a href="summary.html#key-findings"><i class="fa fa-check"></i><b>7.1</b> Key Findings</a></li>
<li class="chapter" data-level="7.2" data-path="summary.html"><a href="summary.html#next-steps"><i class="fa fa-check"></i><b>7.2</b> Next Steps</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">An Example Predictive Modeling Workflow Using The Zillow Prize Dataset</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="feat-eng" class="section level1">
<h1><span class="header-section-number">Chapter 4</span> Feature Engineering</h1>
<p>After we have done an intital EDA of our data we can start doing some feature engineering, this is where we can create new features such as interaction variables, apply transformations such as centering and scaling, choice how we want to encode our categorical features, and also bring in new external information.</p>
<p>Just as in Chapter <a href="eda.html#eda">3</a>, throughout this section we will progressively updating our <code>properties</code> data to include new and transformed features that we are going to continue with into the next stages.</p>
<div id="creating-new-features" class="section level2">
<h2><span class="header-section-number">4.1</span> Creating New Features</h2>
<blockquote>
<p>“Everything is related to everything else, but near things are more related than distant things.”</p>
<p>— Waldo Tobler</p>
</blockquote>
<p>This “First Law of Geography” is something we can take advantage of for creating new features based on our existing ones. In this section we will create based on both data from the Kaggle competition and also examples of external sources as well</p>
<div id="internal-features" class="section level3">
<h3><span class="header-section-number">4.1.1</span> Internal Features</h3>
<p>Since we have the neighborhood, as defined by <code>id_geo_bg_fips</code>, that each parcel is apart of, we can use this to create neighborhood average features.</p>
<p>There are many ways one could define neighborhood for the purposes of using near by parcels, knn for example. Perhaps a more rigourous and certainly more computationly intensive approach would be to estimate the radius at which the spatial autocorrelation of <code>log_error</code> is no longer statistically significant using something such as a bootstrapped spline correlogram such as the function <code>spline.correlog()</code> provided by the <code>ncf</code> package</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ncf<span class="op">::</span><span class="kw">spline.correlog</span>(<span class="dt">x =</span> lon, <span class="dt">y =</span> lat, <span class="dt">z =</span> log_error)</code></pre></div>
<p>For now we will stick with defining our neighborhood by the census block group (<code>id_geo_bg_fips</code>) that each parcel is apart of</p>
<div id="neigborhood-average-properties-features" class="section level4">
<h4><span class="header-section-number">4.1.1.1</span> Neigborhood Average <code>properties</code> Features</h4>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">bg_avg_features &lt;-<span class="st"> </span>properties <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(id_geo_bg_fips) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>id_parcel) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select_if</span>(is.numeric) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarise_all</span>(mean, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(
    <span class="op">!</span><span class="kw">is.na</span>(id_geo_bg_fips)
    )

<span class="kw">names</span>(bg_avg_features) &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;bg_avg_&quot;</span>, <span class="kw">names</span>(bg_avg_features))
<span class="kw">names</span>(bg_avg_features)[<span class="dv">1</span>] &lt;-<span class="st"> &quot;id_geo_bg_fips&quot;</span>

<span class="co"># update the properties table</span>
properties &lt;-<span class="st"> </span>properties <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">left_join</span>(bg_avg_features, <span class="dt">by =</span> <span class="st">&quot;id_geo_bg_fips&quot;</span>)</code></pre></div>
</div>
<div id="rolling-local-average-log_error" class="section level4">
<h4><span class="header-section-number">4.1.1.2</span> Rolling Local Average <code>log_error</code></h4>
<p>There is a strong spatial and temporal autocorrelation to our response variable <code>log_error</code>. To take advantage of this, let’s create a few new features based on the rolling average of the local <code>log_error</code> values.</p>
<p>Because these features will have values for every day from <code>min(trans$date)</code> to <code>max(trans$date)</code> we won’t join them to our data yet.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(tibbletime)

trans_prop &lt;-<span class="st"> </span>properties_geo <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">right_join</span>(trans, <span class="dt">by =</span> <span class="st">&quot;id_parcel&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(
    id_parcel,
    id_geo_bg_fips,
    id_geo_tract_fips,
    date,
    log_error
  )

<span class="co"># create rolling functions ------------------------------------------------</span>

rolling_sum_<span class="dv">7</span> &lt;-<span class="st"> </span><span class="kw">rollify</span>(<span class="op">~</span><span class="kw">sum</span>(.x, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>), <span class="dt">window =</span> <span class="dv">7</span>)
rolling_sum_<span class="dv">28</span> &lt;-<span class="st"> </span><span class="kw">rollify</span>(<span class="op">~</span><span class="kw">sum</span>(.x, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>), <span class="dt">window =</span> <span class="dv">28</span>)

<span class="co"># by block group ----------------------------------------------------------</span>

roll_bg &lt;-<span class="st"> </span><span class="kw">create_series</span>(<span class="kw">min</span>(trans_prop<span class="op">$</span>date) <span class="op">~</span><span class="st"> </span><span class="kw">max</span>(trans_prop<span class="op">$</span>date), 
                   <span class="st">&#39;daily&#39;</span>, <span class="dt">class =</span> <span class="st">&quot;Date&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span>tidyr<span class="op">::</span><span class="kw">expand</span>(
    date, 
    <span class="dt">id_geo_bg_fips =</span> <span class="kw">unique</span>(trans_prop<span class="op">$</span>id_geo_bg_fips)
  ) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">full_join</span>(trans_prop) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(id_geo_bg_fips, date) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarise</span>(
    <span class="dt">sum_log_error =</span> <span class="kw">sum</span>(log_error, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>),
    <span class="dt">sales_total =</span> <span class="kw">sum</span>(<span class="op">!</span><span class="kw">is.na</span>(log_error))
    ) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(id_geo_bg_fips) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(
    <span class="dt">sum_log_error_7days =</span> <span class="kw">rolling_sum_7</span>(sum_log_error),
    <span class="dt">sum_log_error_28days  =</span>  <span class="kw">rolling_sum_28</span>(sum_log_error),
    <span class="dt">roll_bg_trans_total_7days =</span> <span class="kw">rolling_sum_7</span>(sales_total),
    <span class="dt">roll_bg_trans_total_28days  =</span>  <span class="kw">rolling_sum_28</span>(sales_total),
    <span class="dt">roll_bg_avg_log_error_7days =</span> sum_log_error_7days <span class="op">/</span><span class="st"> </span>roll_bg_trans_total_7days,
    <span class="dt">roll_bg_avg_log_error_28days =</span> sum_log_error_28days <span class="op">/</span><span class="st"> </span>roll_bg_trans_total_28days,
    <span class="dt">date =</span> date <span class="op">+</span><span class="st"> </span>lubridate<span class="op">::</span><span class="kw">days</span>(<span class="dv">1</span>) <span class="co"># to not include the current day in avg</span>
  ) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(
    id_geo_bg_fips,
    date,
    roll_bg_trans_total_7days,
    roll_bg_trans_total_28days,
    roll_bg_avg_log_error_7days,
    roll_bg_avg_log_error_28days
  ) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(
    <span class="dt">roll_bg_trans_total_7days =</span> <span class="kw">ifelse</span>(<span class="kw">is.na</span>(roll_bg_trans_total_7days), 
                                       <span class="dv">0</span>, roll_bg_trans_total_7days),
    <span class="dt">roll_bg_trans_total_28days =</span> <span class="kw">ifelse</span>(<span class="kw">is.na</span>(roll_bg_trans_total_28days), 
                                        <span class="dv">0</span>, roll_bg_trans_total_28days),
    <span class="dt">roll_bg_avg_log_error_7days =</span> <span class="kw">ifelse</span>(<span class="kw">is.nan</span>(roll_bg_avg_log_error_7days), 
                                         <span class="dv">0</span>, roll_bg_avg_log_error_7days),
    <span class="dt">roll_bg_avg_log_error_28days =</span> <span class="kw">ifelse</span>(<span class="kw">is.nan</span>(roll_bg_avg_log_error_28days), 
                                          <span class="dv">0</span>, roll_bg_avg_log_error_28days),
    <span class="dt">roll_bg_avg_log_error_7days =</span> <span class="kw">as.numeric</span>(forecast<span class="op">::</span><span class="kw">na.interp</span>(roll_bg_avg_log_error_7days)),
    <span class="dt">roll_bg_avg_log_error_28days =</span> <span class="kw">as.numeric</span>(forecast<span class="op">::</span><span class="kw">na.interp</span>(roll_bg_avg_log_error_28days))
  )

<span class="co"># by tract ----------------------------------------------------------------</span>

roll_tract &lt;-<span class="st"> </span><span class="kw">create_series</span>(<span class="kw">min</span>(trans_prop<span class="op">$</span>date) <span class="op">~</span><span class="st"> </span><span class="kw">max</span>(trans_prop<span class="op">$</span>date), 
                         <span class="st">&#39;daily&#39;</span>, <span class="dt">class =</span> <span class="st">&quot;Date&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span>tidyr<span class="op">::</span><span class="kw">expand</span>(
    date, 
    <span class="dt">id_geo_tract_fips =</span> <span class="kw">unique</span>(trans_prop<span class="op">$</span>id_geo_tract_fips)
  ) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">full_join</span>(trans_prop) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(id_geo_tract_fips, date) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarise</span>(
    <span class="dt">sum_log_error =</span> <span class="kw">sum</span>(log_error, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>),
    <span class="dt">sales_total =</span> <span class="kw">sum</span>(<span class="op">!</span><span class="kw">is.na</span>(log_error))
  ) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(id_geo_tract_fips) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(
    <span class="dt">sum_log_error_7days =</span> <span class="kw">rolling_sum_7</span>(sum_log_error),
    <span class="dt">sum_log_error_28days  =</span>  <span class="kw">rolling_sum_28</span>(sum_log_error),
    <span class="dt">roll_tract_trans_total_7days =</span> <span class="kw">rolling_sum_7</span>(sales_total),
    <span class="dt">roll_tract_trans_total_28days  =</span>  <span class="kw">rolling_sum_28</span>(sales_total),
    <span class="dt">roll_tract_avg_log_error_7days =</span> sum_log_error_7days <span class="op">/</span><span class="st"> </span>roll_tract_trans_total_7days,
    <span class="dt">roll_tract_avg_log_error_28days =</span> sum_log_error_28days <span class="op">/</span><span class="st"> </span>roll_tract_trans_total_28days,
    <span class="dt">date =</span> date <span class="op">+</span><span class="st"> </span>lubridate<span class="op">::</span><span class="kw">days</span>(<span class="dv">1</span>) <span class="co"># to not include the current day in avg</span>
  ) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(
    id_geo_tract_fips,
    date,
    roll_tract_trans_total_7days,
    roll_tract_trans_total_28days,
    roll_tract_avg_log_error_7days,
    roll_tract_avg_log_error_28days
  ) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(
    <span class="dt">roll_tract_trans_total_7days =</span> <span class="kw">ifelse</span>(<span class="kw">is.na</span>(roll_tract_trans_total_7days), 
                                          <span class="dv">0</span>, roll_tract_trans_total_7days),
    <span class="dt">roll_tract_trans_total_28days =</span> <span class="kw">ifelse</span>(<span class="kw">is.na</span>(roll_tract_trans_total_28days), 
                                           <span class="dv">0</span>, roll_tract_trans_total_28days),
    <span class="dt">roll_tract_avg_log_error_7days =</span> <span class="kw">ifelse</span>(<span class="kw">is.nan</span>(roll_tract_avg_log_error_7days), 
                                            <span class="dv">0</span>, roll_tract_avg_log_error_7days),
    <span class="dt">roll_tract_avg_log_error_28days =</span> <span class="kw">ifelse</span>(<span class="kw">is.nan</span>(roll_tract_avg_log_error_28days), 
                                             <span class="dv">0</span>, roll_tract_avg_log_error_28days),
    <span class="dt">roll_tract_avg_log_error_7days =</span> <span class="kw">as.numeric</span>(forecast<span class="op">::</span><span class="kw">na.interp</span>(roll_tract_avg_log_error_7days)),
    <span class="dt">roll_tract_avg_log_error_28days =</span> <span class="kw">as.numeric</span>(forecast<span class="op">::</span><span class="kw">na.interp</span>(roll_tract_avg_log_error_28days))
  )

prop_geo_ids &lt;-<span class="st"> </span>properties_geo <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(
    id_parcel,
    id_geo_bg_fips,
    id_geo_tract_fips
  )

<span class="kw">write_feather</span>(roll_bg, <span class="st">&quot;data/external-features/roll_features_blockgroup.feather&quot;</span>)
<span class="kw">write_feather</span>(roll_tract, <span class="st">&quot;data/external-features/roll_features_tract.feather&quot;</span>)</code></pre></div>
</div>
</div>
<div id="external-features" class="section level3">
<h3><span class="header-section-number">4.1.2</span> External Features</h3>
<p>Breaking from the rules of the actual Kaggle competition, we’re going to add in some external features as an example of bringing in other information</p>
<div id="american-community-survey" class="section level4">
<h4><span class="header-section-number">4.1.2.1</span> American Community Survey</h4>
<p>The <a href="https://www.census.gov/programs-surveys/acs/">American Community Survey</a> is a great source of demographic and household data. As an example of using this data let’s bring in a few features related to our area of interest.</p>
<p>In our example here, we are completely ignoring the margin or error for each feature, given more time investigating the information contained in these fields is most likely worth your while.</p>
<p>There are literally thousands you can explore in the ACS. For our example, we are going to use a few</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(tidycensus)

api_key &lt;-<span class="st"> </span><span class="kw">Sys.getenv</span>(<span class="st">&quot;CENSUS_API_KEY&quot;</span>)
<span class="kw">census_api_key</span>(api_key)

acs_var_list &lt;-<span class="st"> </span><span class="kw">load_variables</span>(<span class="dv">2016</span>, <span class="st">&quot;acs5&quot;</span>, <span class="dt">cache =</span> <span class="ot">TRUE</span>)

acs_bg_vars &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;B25034_001E&quot;</span>, <span class="st">&quot;B25034_002E&quot;</span>, <span class="st">&quot;B25034_003E&quot;</span>, 
                 <span class="st">&quot;B25034_004E&quot;</span>, <span class="st">&quot;B25034_005E&quot;</span>, <span class="st">&quot;B25034_006E&quot;</span>,
                 <span class="st">&quot;B25034_007E&quot;</span>, <span class="st">&quot;B25034_008E&quot;</span>, <span class="st">&quot;B25034_009E&quot;</span>,
                 <span class="st">&quot;B25034_010E&quot;</span>, <span class="st">&quot;B25034_011E&quot;</span>, <span class="st">&quot;B25076_001E&quot;</span>, 
                 <span class="st">&quot;B25077_001E&quot;</span>, <span class="st">&quot;B25078_001E&quot;</span>, <span class="st">&quot;B25056_001E&quot;</span>, 
                 <span class="st">&quot;B25002_001E&quot;</span>, <span class="st">&quot;B25002_003E&quot;</span>, <span class="st">&quot;B25001_001E&quot;</span>)

acs_bg_home_value &lt;-<span class="st"> </span>acs_var_list <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(<span class="kw">grepl</span>(<span class="st">&quot;B25075_&quot;</span>, <span class="dt">x =</span> name))

acs_bg_home_value_vars &lt;-<span class="st"> </span>acs_bg_home_value<span class="op">$</span>name

acs_bg_vars &lt;-<span class="st"> </span><span class="kw">c</span>(acs_bg_vars, acs_bg_home_value_vars)

acs_bg_data &lt;-<span class="st"> </span><span class="kw">get_acs</span>(
  <span class="dt">geography =</span> <span class="st">&quot;block group&quot;</span>, 
  <span class="dt">variables =</span> acs_bg_vars, 
  <span class="dt">state =</span> <span class="st">&quot;CA&quot;</span>,
  <span class="dt">county =</span> <span class="kw">c</span>(<span class="st">&quot;Los Angeles&quot;</span>, <span class="st">&quot;Orange&quot;</span>, <span class="st">&quot;Ventura&quot;</span>),
  <span class="dt">output =</span> <span class="st">&quot;wide&quot;</span>,
  <span class="dt">geometry =</span> <span class="ot">FALSE</span>, 
  <span class="dt">keep_geo_vars =</span> <span class="ot">TRUE</span>
)

acs_bg_data1 &lt;-<span class="st"> </span>acs_bg_data <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(
    <span class="dt">id_geo_bg_fips =</span> GEOID,
    <span class="dt">acs_str_yr_total =</span> B25034_001E,
    <span class="dt">acs_str_yr_2014_later =</span> B25034_002E,
    <span class="dt">acs_str_yr_2010_2013 =</span> B25034_003E,
    <span class="dt">acs_str_yr_2000_2009 =</span> B25034_004E,
    <span class="dt">acs_str_yr_1990_1999 =</span> B25034_005E,
    <span class="dt">acs_str_yr_1980_1989 =</span> B25034_006E,
    <span class="dt">acs_str_yr_1970_1979 =</span> B25034_007E,
    <span class="dt">acs_str_yr_1960_1969 =</span> B25034_008E,
    <span class="dt">acs_str_yr_1950_1959 =</span> B25034_009E,
    <span class="dt">acs_str_yr_1940_1949 =</span> B25034_010E,
    <span class="dt">acs_str_yr_1939_earlier =</span> B25034_011E,
    <span class="dt">acs_home_value_lwr =</span> B25076_001E,
    <span class="dt">acs_home_value_med =</span> B25077_001E,
    <span class="dt">acs_home_value_upr =</span> B25078_001E,
    <span class="dt">acs_num_of_renters_total =</span> B25056_001E,
    <span class="dt">acs_num_of_house_units =</span> B25001_001E,
    <span class="dt">acs_occ_status_total =</span> B25002_001E,
    <span class="dt">acs_occ_status_vacant =</span> B25002_003E,
    <span class="dt">acs_home_value_cnt_total =</span> B25075_001E,
    <span class="dt">acs_home_value_cnt_less_10k =</span> B25075_002E,
    <span class="dt">acs_home_value_cnt_10k_15k =</span> B25075_003E,
    <span class="dt">acs_home_value_cnt_15k_20k =</span> B25075_004E,
    <span class="dt">acs_home_value_cnt_20k_25k =</span> B25075_005E,
    <span class="dt">acs_home_value_cnt_25k_30k =</span> B25075_006E,
    <span class="dt">acs_home_value_cnt_30k_35k =</span> B25075_007E,
    <span class="dt">acs_home_value_cnt_35k_40k =</span> B25075_008E,
    <span class="dt">acs_home_value_cnt_40k_50k =</span> B25075_009E,
    <span class="dt">acs_home_value_cnt_50k_60k =</span> B25075_010E,
    <span class="dt">acs_home_value_cnt_60k_70k =</span> B25075_011E,
    <span class="dt">acs_home_value_cnt_70k_80k =</span> B25075_012E,
    <span class="dt">acs_home_value_cnt_80k_90k =</span> B25075_013E,
    <span class="dt">acs_home_value_cnt_90k_100k =</span> B25075_014E,
    <span class="dt">acs_home_value_cnt_100k_125k =</span> B25075_015E,
    <span class="dt">acs_home_value_cnt_125k_150k =</span> B25075_016E,
    <span class="dt">acs_home_value_cnt_150k_175k =</span> B25075_017E,
    <span class="dt">acs_home_value_cnt_175k_200k =</span> B25075_018E,
    <span class="dt">acs_home_value_cnt_200k_250k =</span> B25075_019E,
    <span class="dt">acs_home_value_cnt_250k_300k =</span> B25075_020E,
    <span class="dt">acs_home_value_cnt_300k_400k =</span> B25075_021E,
    <span class="dt">acs_home_value_cnt_400k_500k =</span> B25075_022E,
    <span class="dt">acs_home_value_cnt_500k_750k =</span> B25075_023E,
    <span class="dt">acs_home_value_cnt_750k_1000k =</span> B25075_024E,
    <span class="dt">acs_home_value_cnt_1000k_1500k =</span> B25075_025E,
    <span class="dt">acs_home_value_cnt_1500k_2000k =</span> B25075_026E,
    <span class="dt">acs_home_value_cnt_2000k_more =</span> B25075_027E
  ) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate_at</span>(
    <span class="kw">vars</span>(<span class="kw">starts_with</span>(<span class="st">&quot;acs_home_value_cnt&quot;</span>)), <span class="cf">function</span>(x) <span class="kw">round</span>(x <span class="op">/</span><span class="st"> </span>.<span class="op">$</span>acs_home_value_cnt_total, <span class="dt">digits =</span> <span class="dv">5</span>)
    ) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate_at</span>(
    <span class="kw">vars</span>(<span class="kw">starts_with</span>(<span class="st">&quot;acs_str_yr&quot;</span>)), <span class="cf">function</span>(x) <span class="kw">round</span>(x <span class="op">/</span><span class="st"> </span>.<span class="op">$</span>acs_str_yr_total, <span class="dt">digits =</span> <span class="dv">5</span>)
  ) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(
    <span class="dt">acs_per_renters =</span> <span class="kw">round</span>(acs_num_of_renters_total <span class="op">/</span><span class="st"> </span>acs_num_of_house_units, <span class="dt">digits =</span> <span class="dv">5</span>),
    <span class="dt">acs_per_vacant =</span> <span class="kw">round</span>(acs_occ_status_vacant <span class="op">/</span><span class="st"> </span>acs_occ_status_total, <span class="dt">digits =</span> <span class="dv">5</span>)
  ) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(
    <span class="op">-</span>acs_occ_status_total, 
    <span class="op">-</span>acs_home_value_cnt_total, 
    <span class="op">-</span>acs_str_yr_total
    )

acs_features &lt;-<span class="st"> </span>properties_geo <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(
    id_parcel,
    id_geo_bg_fips
    ) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">left_join</span>(acs_bg_data1, <span class="dt">by =</span> <span class="st">&quot;id_geo_bg_fips&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>id_geo_bg_fips)

properties &lt;-<span class="st"> </span>properties <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">left_join</span>(acs_features, <span class="dt">by =</span> <span class="st">&quot;id_parcel&quot;</span>)</code></pre></div>
</div>
<div id="economic-indicators" class="section level4">
<h4><span class="header-section-number">4.1.2.2</span> Economic Indicators</h4>
<p>The value of a home is not only influenced by itself and its neighbors, but also larger economic trends. To help account for this in our model we are going to add in the following economic indicators</p>
<ul>
<li><a href="https://fred.stlouisfed.org/series/MORTGAGE30US">30-Year Fixed Rate Mortgage Average in the United States</a></li>
<li><a href="https://fred.stlouisfed.org/series/LXXRSA">S&amp;P/Case-Shiller CA-Los Angeles Home Price Index</a></li>
<li><a href="https://fred.stlouisfed.org/series/CALOSA7URN">Unemployment Rate in Los Angeles County, CA</a></li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(alfred)

<span class="co"># 30-Year Fixed Rate Mortgage Average in the United States (weekly)</span>
mort30 &lt;-<span class="st"> </span><span class="kw">get_fred_series</span>(<span class="st">&quot;MORTGAGE30US&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(
    <span class="dt">date_month =</span> <span class="kw">floor_date</span>(date, <span class="dt">unit =</span> <span class="st">&quot;month&quot;</span>),
    <span class="dt">date_week =</span> <span class="kw">floor_date</span>(date, <span class="dt">unit =</span> <span class="st">&quot;week&quot;</span>)
    )

<span class="co"># S&amp;P/Case-Shiller CA-Los Angeles Home Price Index (monthly)</span>
spcs &lt;-<span class="st"> </span><span class="kw">get_fred_series</span>(<span class="st">&quot;LXXRNSA&quot;</span>)

<span class="co"># Unemployment Rate in Los Angeles County, CA (monthly)</span>
unemployment &lt;-<span class="st"> </span><span class="kw">get_fred_series</span>(<span class="st">&quot;CALOSA7URN&quot;</span>)

econ_features &lt;-<span class="st"> </span><span class="kw">create_series</span>(<span class="kw">min</span>(mort30<span class="op">$</span>date) <span class="op">~</span><span class="st"> </span><span class="kw">max</span>(mort30<span class="op">$</span>date), 
                               <span class="st">&#39;daily&#39;</span>, <span class="dt">class =</span> <span class="st">&quot;Date&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">date_week =</span> <span class="kw">floor_date</span>(date, <span class="dt">unit =</span> <span class="st">&quot;week&quot;</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">left_join</span>(mort30, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;date_week&quot;</span> =<span class="st"> &quot;date_week&quot;</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">left_join</span>(spcs, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;date_month&quot;</span> =<span class="st"> &quot;date&quot;</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">left_join</span>(unemployment, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;date_month&quot;</span> =<span class="st"> &quot;date&quot;</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(
    <span class="dt">date =</span> date.x,
    <span class="dt">econ_mort_30 =</span> MORTGAGE30US,
    <span class="dt">econ_case_shiller =</span> LXXRNSA,
    <span class="dt">econ_unemployment =</span> CALOSA7URN
  ) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(
    date <span class="op">&gt;=</span><span class="st"> </span><span class="kw">date</span>(<span class="st">&quot;2015-12-01&quot;</span>),
    date <span class="op">&lt;=</span><span class="st"> </span><span class="kw">date</span>(<span class="st">&quot;2018-01-01&quot;</span>)
    )

<span class="kw">write_feather</span>(econ_features, <span class="st">&quot;data/external-features/econ_features.feather&quot;</span>)</code></pre></div>
<p>Ok, so a check in on where we are. We currently have 5 data frames of interest, our old friends <code>properties</code> which now contains new features from our <code>bg_avg_features</code> neighborhood data and the <code>acs_features</code> which contain a few indicators from the American Community Survey and <code>trans</code> which contains our response variable <code>log_error</code> as well as the transaction date and a few date based features.</p>
<p>The other 3 data frames we have are seperated from the <code>properties</code> and <code>trans</code> data currently because they contain features that have different values for each day and depending on what our transaction dates are for the partiuclar set of observations we will use filter those values down and join them at the time of training.</p>
</div>
</div>
</div>
<div id="handling-missing-data" class="section level2">
<h2><span class="header-section-number">4.2</span> Handling Missing Data</h2>
<p>There are many ways to handle missing data from simple mean or median imputation to more complex methods such as knn or multiple imputation or even constructing other predictive models for predicting missing features. We will not explore that topic in depth here and use a somewhat simple approach that takes advantage of the spatial relationships of our data.</p>
<p>We will use median (or modal for nominal features) imputation but instead of doing global median values for all observations, we are going to break our observations into subspaces based on <code>zoning_landuse</code>, <code>area_lot</code>, and increasingly larger neigborhood windows. The reasoning behind this choice is that the values for many of the other features can vary widely across these categories. For example it wouldn’t make sense to include the <code>tax_building</code> values for mobile homes if we are imputing the <code>tax_building</code> value of a commercial office building. The is true for <code>area_lot</code> the tax burden on a large commercial office will be larger then the one of a smaller office.</p>
<p>So we will look at increaingly larger neighborhoods of <code>zoning_landuse</code> and (a discretized version of) <code>area_lot</code> combinations, if there are any none <code>NA</code> observations of that combination in the missing observations block group, fill its values with the block group median (mode), if there are no non-missing observations with that combination in that block group, then look at the tract level, if there are none at the tract look at the county level, and finally if there are no non-missing observations in the County that the parcel belongs to, an unlikely event, then use the “global” values to impute.</p>
<p>To do this we first need to impute the values for <code>zoning_landuse</code> and <code>area_lot</code>. For this we will just use the increasing neighborhood search for <code>zoning_landuse</code> and then use the increasing neighborhood search broken down by <code>zoning_landuse</code> to fill in <code>area_lot</code></p>
<p>For some reason their are no built in functions for calculating the mode. Make a simple helper function to do so</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># simple helper function to find the mode</span>
fct_mode &lt;-<span class="st"> </span><span class="cf">function</span>(f) {
  
  f_no_na &lt;-<span class="st"> </span><span class="kw">na.omit</span>(f)
  fct_tab &lt;-<span class="st"> </span><span class="kw">table</span>(f_no_na)
  
  <span class="co"># if everything NA return NA</span>
  <span class="cf">if</span> (<span class="kw">length</span>(fct_tab) <span class="op">==</span><span class="st"> </span><span class="dv">0</span>) <span class="kw">return</span>(<span class="ot">NA</span>)
  
  modal_fct &lt;-<span class="st"> </span><span class="kw">names</span>(fct_tab)[<span class="kw">which</span>(fct_tab <span class="op">==</span><span class="st"> </span><span class="kw">max</span>(fct_tab))]
  modal_fct &lt;-<span class="st"> </span>modal_fct[<span class="dv">1</span>] <span class="co"># in case of ties, go with first one</span>
  
  modal_fct
}</code></pre></div>
<p>Some parcels have no information at all including geographic ids. Randomly assign them a <code>id_geo_bg_fips</code> value based block group frequency</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">parcels_no_info &lt;-<span class="st"> </span>properties <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(
    <span class="kw">is.na</span>(id_geo_bg_fips)
    ) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(id_parcel)

bg_probs &lt;-<span class="st"> </span><span class="kw">table</span>(properties<span class="op">$</span>id_geo_bg_fips) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">as.data.frame</span>()

bg_assignments &lt;-<span class="st"> </span><span class="kw">sample</span>(bg_probs<span class="op">$</span>Var1, 
                         <span class="dt">size =</span> <span class="kw">nrow</span>(parcels_no_info), 
                         <span class="dt">replace =</span> <span class="ot">TRUE</span>, 
                         <span class="dt">prob =</span> bg_probs<span class="op">$</span>Freq)

bg_assignments &lt;-<span class="st"> </span><span class="kw">as.character</span>(bg_assignments)

parcels_no_info_row_id &lt;-<span class="st"> </span>properties<span class="op">$</span>id_parcel <span class="op">%in%</span><span class="st"> </span>parcels_no_info<span class="op">$</span>id_parcel

properties[parcels_no_info_row_id , <span class="st">&quot;id_geo_bg_fips&quot;</span>] &lt;-<span class="st"> </span>bg_assignments

<span class="co"># fill in the missing tract and county based on bg</span>
properties &lt;-<span class="st"> </span>properties <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(id_geo_bg_fips) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(
    <span class="dt">id_geo_tract_fips =</span> <span class="kw">fct_mode</span>(id_geo_tract_fips)
    ) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(id_geo_tract_fips) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(
    <span class="dt">id_geo_county_fips =</span> <span class="kw">fct_mode</span>(id_geo_county_fips)
  ) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ungroup</span>()</code></pre></div>
<p>Now that all observations have at least geo id values we can impute <code>zoning_landuse</code> using the increasing neighborhood search</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">properties &lt;-<span class="st"> </span>properties <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(id_geo_bg_fips) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(
    <span class="dt">zoning_landuse =</span> <span class="kw">replace_na</span>(zoning_landuse, <span class="kw">fct_mode</span>(zoning_landuse))
  ) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(id_geo_tract_fips) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(
    <span class="dt">zoning_landuse =</span> <span class="kw">replace_na</span>(zoning_landuse, <span class="kw">fct_mode</span>(zoning_landuse))
  ) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(id_geo_county_fips) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(
    <span class="dt">zoning_landuse =</span> <span class="kw">replace_na</span>(zoning_landuse, <span class="kw">fct_mode</span>(zoning_landuse))
  ) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ungroup</span>()</code></pre></div>
<p>Now for <code>area_lot</code></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">properties &lt;-<span class="st"> </span>properties <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(
    id_geo_bg_fips,
    zoning_landuse
    ) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(
    <span class="dt">area_lot =</span> <span class="kw">replace_na</span>(area_lot, <span class="kw">median</span>(area_lot, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))
  ) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(
    id_geo_tract_fips,
    zoning_landuse    
    ) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(
    <span class="dt">area_lot =</span> <span class="kw">replace_na</span>(area_lot, <span class="kw">median</span>(area_lot, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))
  ) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(
    id_geo_county_fips,
    zoning_landuse
    ) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(
    <span class="dt">area_lot =</span> <span class="kw">replace_na</span>(area_lot, <span class="kw">median</span>(area_lot, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))
  ) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ungroup</span>()</code></pre></div>
<p>OK, now for the rest of them. Becasue we used <code>median()</code> to fill in <code>area_lot</code> the <code>quantile()</code> are not unique, so add a little bit of noise <code>area_lot_jitter</code> and base the breaks on those.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># impute all other features based on neighborhood, zoning_landuse, and area_lot</span>
properties &lt;-<span class="st"> </span>properties <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(
    <span class="dt">area_lot_jitter =</span> area_lot <span class="op">+</span><span class="st"> </span><span class="kw">runif</span>(<span class="dt">n =</span> <span class="kw">n</span>(), <span class="dt">min =</span> <span class="op">-</span><span class="dv">1</span>, <span class="dt">max =</span> <span class="dv">1</span>),
    <span class="dt">area_lot_quantile =</span> <span class="kw">cut</span>(area_lot_jitter, 
                            <span class="dt">breaks =</span> <span class="kw">quantile</span>(area_lot_jitter, <span class="dt">probs =</span> <span class="kw">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="fl">0.1</span>), <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))
    ) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(
    id_geo_bg_fips,
    zoning_landuse,
    area_lot_quantile
  ) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate_if</span>(
    is.numeric, <span class="dt">.funs =</span> <span class="cf">function</span>(x) <span class="kw">replace_na</span>(x, <span class="kw">median</span>(x, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))
    ) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate_if</span>(
    is.factor, <span class="dt">.funs =</span> <span class="cf">function</span>(x) <span class="kw">replace_na</span>(x, <span class="kw">fct_mode</span>(x))
  ) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(
    id_geo_tract_fips,
    zoning_landuse,
    area_lot_quantile
  ) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate_if</span>(
    is.numeric, <span class="dt">.funs =</span> <span class="cf">function</span>(x) <span class="kw">replace_na</span>(x, <span class="kw">median</span>(x, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))
  ) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate_if</span>(
    is.factor, <span class="dt">.funs =</span> <span class="cf">function</span>(x) <span class="kw">replace_na</span>(x, <span class="kw">fct_mode</span>(x))
  ) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(
    id_geo_county_fips,
    zoning_landuse,
    area_lot_quantile
  ) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate_if</span>(
    is.numeric, <span class="dt">.funs =</span> <span class="cf">function</span>(x) <span class="kw">replace_na</span>(x, <span class="kw">median</span>(x, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))
  ) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate_if</span>(
    is.factor, <span class="dt">.funs =</span> <span class="cf">function</span>(x) <span class="kw">replace_na</span>(x, <span class="kw">fct_mode</span>(x))
  ) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(
    zoning_landuse,
    area_lot_quantile
  ) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate_if</span>(
    is.numeric, <span class="dt">.funs =</span> <span class="cf">function</span>(x) <span class="kw">replace_na</span>(x, <span class="kw">median</span>(x, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))
  ) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate_if</span>(
    is.factor, <span class="dt">.funs =</span> <span class="cf">function</span>(x) <span class="kw">replace_na</span>(x, <span class="kw">fct_mode</span>(x))
  ) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ungroup</span>()</code></pre></div>
<p>At this point we now have all the original features we are going to use and have filled in all missing values. The next step is to transform our features, create interaction features, and then move unto feature selection.</p>
</div>
<div id="feature-transformation" class="section level2">
<h2><span class="header-section-number">4.3</span> Feature Transformation</h2>
<p>Combine all of our data and remove a handful of features that we aren’t going to use</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># have to remove id_geo after joins because of time features</span>
d &lt;-<span class="st"> </span>trans <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">left_join</span>(properties, <span class="dt">by =</span> <span class="st">&quot;id_parcel&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">left_join</span>(econ_features, <span class="dt">by =</span> <span class="st">&quot;date&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">left_join</span>(roll_bg, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;id_geo_bg_fips&quot;</span>, <span class="st">&quot;date&quot;</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">left_join</span>(roll_tract, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;id_geo_tract_fips&quot;</span>, <span class="st">&quot;date&quot;</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(
    <span class="op">-</span>id_parcel,
    <span class="op">-</span>abs_log_error,
    <span class="op">-</span>week,
    <span class="op">-</span>region_city,
    <span class="op">-</span>region_zip,
    <span class="op">-</span>area_lot_jitter,
    <span class="op">-</span>area_lot_quantile,
    <span class="op">-</span>lat, <span class="co"># we have other lat/lon features</span>
    <span class="op">-</span>lon, 
    <span class="op">-</span><span class="kw">starts_with</span>(<span class="st">&quot;id_geo&quot;</span>)
  ) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(
    <span class="dt">date =</span> <span class="kw">as.numeric</span>(date),
    <span class="dt">year =</span> <span class="kw">factor</span>(year, <span class="dt">levels =</span> <span class="kw">sort</span>(<span class="kw">unique</span>(year)), <span class="dt">ordered =</span> <span class="ot">TRUE</span>),
    <span class="dt">month_year =</span> <span class="kw">factor</span>(
      <span class="kw">as.character</span>(month_year), 
      <span class="dt">levels =</span> <span class="kw">as.character</span>(<span class="kw">unique</span>(<span class="kw">sort</span>(month_year))), 
      <span class="dt">ordered =</span> <span class="ot">TRUE</span>),
    <span class="dt">str_quality =</span> <span class="kw">factor</span>(str_quality, <span class="dt">levels =</span> <span class="dv">12</span><span class="op">:</span><span class="dv">1</span>, <span class="dt">ordered =</span> <span class="ot">TRUE</span>)
  )</code></pre></div>
<p>Here we are going to use the <code>recipes</code> package to handle all of our feature transformations. The main transformations we are going to apply are as follows</p>
<ol style="list-style-type: decimal">
<li>Apply a Box-Cox transformation on the features that were highly skewed</li>
<li>Creating dummy variables using one hot encoding for non ordered factors and polynomial spline for ordered factors</li>
<li>Create interaction features from all of the <code>tax_*</code> and <code>area_*</code> features</li>
<li>Center and Scale all the predictors</li>
<li>Transform the several <code>acs_home_value_cnt_*</code> features using PCA. Keep only 5</li>
<li>Remove any Features that have zero variance</li>
</ol>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(recipes)

rec &lt;-<span class="st"> </span><span class="kw">recipe</span>(d) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">add_role</span>(log_error, <span class="dt">new_role =</span> <span class="st">&#39;outcome&#39;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">add_role</span>(<span class="op">-</span>log_error, <span class="dt">new_role =</span> <span class="st">&#39;predictor&#39;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">step_meanimpute</span>(<span class="kw">starts_with</span>(<span class="st">&quot;roll_&quot;</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">step_zv</span>(<span class="kw">all_numeric</span>()) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">step_BoxCox</span>(
    <span class="kw">starts_with</span>(<span class="st">&quot;num_&quot;</span>), 
    <span class="kw">starts_with</span>(<span class="st">&quot;area_&quot;</span>),
    <span class="kw">starts_with</span>(<span class="st">&quot;tax_&quot;</span>),
    <span class="kw">starts_with</span>(<span class="st">&quot;bg_avg_num_&quot;</span>), 
    <span class="kw">starts_with</span>(<span class="st">&quot;bg_avg_area_&quot;</span>),
    <span class="kw">starts_with</span>(<span class="st">&quot;bg_avg_tax_&quot;</span>)
  ) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">step_dummy</span>(<span class="kw">all_nominal</span>(), <span class="dt">one_hot =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">step_interact</span>(<span class="op">~</span><span class="kw">starts_with</span>(<span class="st">&quot;tax_&quot;</span>)<span class="op">:</span><span class="kw">starts_with</span>(<span class="st">&quot;area_&quot;</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">step_center</span>(<span class="kw">all_numeric</span>(), <span class="op">-</span><span class="kw">all_outcomes</span>()) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">step_scale</span>(<span class="kw">all_numeric</span>(), <span class="op">-</span><span class="kw">all_outcomes</span>()) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">step_pca</span>(<span class="kw">starts_with</span>(<span class="st">&quot;acs_home_value_cnt&quot;</span>), <span class="dt">prefix =</span> <span class="st">&quot;acs_home_value_cnt_PC&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">step_zv</span>(<span class="kw">all_numeric</span>())
  
rec_prepped &lt;-<span class="st"> </span><span class="kw">prep</span>(rec, <span class="dt">training =</span> d)</code></pre></div>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="eda.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="feature-selection.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"linkedin": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"download": ["zillow-prize.pdf", "zillow-prize.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "";
    if (src === "" || src === "true") src = "https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(src))
      src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
