<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>An Example Predictive Modeling Workflow Using The Zillow Prize Dataset</title>
  <meta name="description" content="This is to document an example workflow and predictive modeling process using the Kaggle Zillow competition as an example.">
  <meta name="generator" content="bookdown 0.7 and GitBook 2.6.7">

  <meta property="og:title" content="An Example Predictive Modeling Workflow Using The Zillow Prize Dataset" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This is to document an example workflow and predictive modeling process using the Kaggle Zillow competition as an example." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="An Example Predictive Modeling Workflow Using The Zillow Prize Dataset" />
  
  <meta name="twitter:description" content="This is to document an example workflow and predictive modeling process using the Kaggle Zillow competition as an example." />
  

<meta name="author" content="Jesse Piburn">


<meta name="date" content="2018-07-21">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="intro.html">
<link rel="next" href="eda.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />







<script src="libs/htmlwidgets-1.2/htmlwidgets.js"></script>
<link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-1.3.1/leaflet.js"></script>
<link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
<script src="libs/Proj4Leaflet-1.0.1/proj4-compressed.js"></script>
<script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
<link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-binding-2.0.1/leaflet.js"></script>
<script src="libs/leaflet-providers-1.1.17/leaflet-providers.js"></script>
<script src="libs/leaflet-providers-plugin-2.0.1/leaflet-providers-plugin.js"></script>
<script src="libs/lfx-heat-0.1.0/lfx-heat-prod.js"></script>
<script src="libs/lfx-heat-0.1.0/lfx-heat-bindings.js"></script>
<script src="libs/datatables-binding-0.2/datatables.js"></script>
<link href="libs/dt-core-1.10.12/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="libs/dt-core-1.10.12/css/jquery.dataTables.extra.css" rel="stylesheet" />
<script src="libs/dt-core-1.10.12/js/jquery.dataTables.min.js"></script>
<link href="libs/dt-ext-fixedcolumns-1.10.12/css/fixedColumns.dataTables.min.css" rel="stylesheet" />
<script src="libs/dt-ext-fixedcolumns-1.10.12/js/dataTables.fixedColumns.min.js"></script>
<script src="libs/plotly-binding-4.7.1/plotly.js"></script>
<script src="libs/typedarray-0.1/typedarray.min.js"></script>
<link href="libs/crosstalk-1.0.0/css/crosstalk.css" rel="stylesheet" />
<script src="libs/crosstalk-1.0.0/js/crosstalk.min.js"></script>
<link href="libs/plotlyjs-1.29.2/plotly-htmlwidgets.css" rel="stylesheet" />
<script src="libs/plotlyjs-1.29.2/plotly-latest.min.js"></script>


<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Predictive Modeling Workflow</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Welcome</a></li>
<li class="chapter" data-level="1" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>1</b> Introduction</a><ul>
<li class="chapter" data-level="1.1" data-path="intro.html"><a href="intro.html#problem"><i class="fa fa-check"></i><b>1.1</b> Problem</a></li>
<li class="chapter" data-level="1.2" data-path="intro.html"><a href="intro.html#evaluation"><i class="fa fa-check"></i><b>1.2</b> Evaluation</a></li>
<li class="chapter" data-level="1.3" data-path="intro.html"><a href="intro.html#initital-thoughts"><i class="fa fa-check"></i><b>1.3</b> Initital Thoughts</a></li>
<li class="chapter" data-level="1.4" data-path="intro.html"><a href="intro.html#note-on-using-external-features"><i class="fa fa-check"></i><b>1.4</b> Note on Using External Features</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="preprocessing.html"><a href="preprocessing.html"><i class="fa fa-check"></i><b>2</b> PreProcessing</a><ul>
<li class="chapter" data-level="2.1" data-path="preprocessing.html"><a href="preprocessing.html#the-raw-data"><i class="fa fa-check"></i><b>2.1</b> The Raw Data</a><ul>
<li class="chapter" data-level="2.1.1" data-path="preprocessing.html"><a href="preprocessing.html#saving-raw-data-using-feather"><i class="fa fa-check"></i><b>2.1.1</b> Saving Raw Data Using <code>feather</code></a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="preprocessing.html"><a href="preprocessing.html#renaming-variables"><i class="fa fa-check"></i><b>2.2</b> Renaming Variables</a><ul>
<li class="chapter" data-level="2.2.1" data-path="preprocessing.html"><a href="preprocessing.html#renaming-properties-features"><i class="fa fa-check"></i><b>2.2.1</b> Renaming <code>properties</code> Features</a></li>
<li class="chapter" data-level="2.2.2" data-path="preprocessing.html"><a href="preprocessing.html#renaming-train-features"><i class="fa fa-check"></i><b>2.2.2</b> renaming <code>train</code> features</a></li>
<li class="chapter" data-level="2.2.3" data-path="preprocessing.html"><a href="preprocessing.html#basic-transformations"><i class="fa fa-check"></i><b>2.2.3</b> Basic Transformations</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="preprocessing.html"><a href="preprocessing.html#extracting-geographic-information"><i class="fa fa-check"></i><b>2.3</b> Extracting Geographic Information</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="eda.html"><a href="eda.html"><i class="fa fa-check"></i><b>3</b> Exploratory Analysis</a><ul>
<li class="chapter" data-level="3.1" data-path="eda.html"><a href="eda.html#response-variable"><i class="fa fa-check"></i><b>3.1</b> Response Variable</a><ul>
<li class="chapter" data-level="3.1.1" data-path="eda.html"><a href="eda.html#transactions-over-time"><i class="fa fa-check"></i><b>3.1.1</b> Transactions Over Time</a></li>
<li class="chapter" data-level="3.1.2" data-path="eda.html"><a href="eda.html#spatial-distribution-of-log_error"><i class="fa fa-check"></i><b>3.1.2</b> Spatial Distribution of <code>log_error</code></a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="eda.html"><a href="eda.html#predictor-variables"><i class="fa fa-check"></i><b>3.2</b> Predictor Variables</a><ul>
<li class="chapter" data-level="3.2.1" data-path="eda.html"><a href="eda.html#missingness"><i class="fa fa-check"></i><b>3.2.1</b> Missingness</a></li>
<li class="chapter" data-level="3.2.2" data-path="eda.html"><a href="eda.html#numeric-features"><i class="fa fa-check"></i><b>3.2.2</b> Numeric Features</a></li>
<li class="chapter" data-level="3.2.3" data-path="eda.html"><a href="eda.html#numeric-outliers"><i class="fa fa-check"></i><b>3.2.3</b> Numeric Outliers</a></li>
<li class="chapter" data-level="3.2.4" data-path="eda.html"><a href="eda.html#categorical-features"><i class="fa fa-check"></i><b>3.2.4</b> Categorical Features</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="eda.html"><a href="eda.html#exploring-log_error-a-little-more"><i class="fa fa-check"></i><b>3.3</b> Exploring <code>log_error</code> A little More</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="feat-eng.html"><a href="feat-eng.html"><i class="fa fa-check"></i><b>4</b> Feature Engineering</a><ul>
<li class="chapter" data-level="4.1" data-path="feat-eng.html"><a href="feat-eng.html#creating-new-features"><i class="fa fa-check"></i><b>4.1</b> Creating New Features</a><ul>
<li class="chapter" data-level="4.1.1" data-path="feat-eng.html"><a href="feat-eng.html#internal-features"><i class="fa fa-check"></i><b>4.1.1</b> Internal Features</a></li>
<li class="chapter" data-level="4.1.2" data-path="feat-eng.html"><a href="feat-eng.html#external-features"><i class="fa fa-check"></i><b>4.1.2</b> External Features</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="feat-eng.html"><a href="feat-eng.html#handling-missing-data"><i class="fa fa-check"></i><b>4.2</b> Handling Missing Data</a></li>
<li class="chapter" data-level="4.3" data-path="feat-eng.html"><a href="feat-eng.html#feature-transformation"><i class="fa fa-check"></i><b>4.3</b> Feature Transformation</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="feature-selection.html"><a href="feature-selection.html"><i class="fa fa-check"></i><b>5</b> Feature Selection</a><ul>
<li class="chapter" data-level="5.1" data-path="feature-selection.html"><a href="feature-selection.html#generate-importance-helper-function"><i class="fa fa-check"></i><b>5.1</b> Generate Importance Helper Function</a></li>
<li class="chapter" data-level="5.2" data-path="feature-selection.html"><a href="feature-selection.html#v-fold-cross-validation-resampling"><i class="fa fa-check"></i><b>5.2</b> V-Fold Cross Validation Resampling</a></li>
<li class="chapter" data-level="5.3" data-path="feature-selection.html"><a href="feature-selection.html#inspect-importance-results"><i class="fa fa-check"></i><b>5.3</b> Inspect Importance Results</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="modeling.html"><a href="modeling.html"><i class="fa fa-check"></i><b>6</b> Modeling</a><ul>
<li class="chapter" data-level="6.1" data-path="modeling.html"><a href="modeling.html#xgboost"><i class="fa fa-check"></i><b>6.1</b> XGBoost</a></li>
<li class="chapter" data-level="6.2" data-path="modeling.html"><a href="modeling.html#our-recipe-for-success"><i class="fa fa-check"></i><b>6.2</b> Our Recipe for Success</a></li>
<li class="chapter" data-level="6.3" data-path="modeling.html"><a href="modeling.html#base-line-model"><i class="fa fa-check"></i><b>6.3</b> Base Line Model</a><ul>
<li class="chapter" data-level="6.3.1" data-path="modeling.html"><a href="modeling.html#making-predictions-with-base-line-model"><i class="fa fa-check"></i><b>6.3.1</b> Making Predictions with Base Line Model</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="modeling.html"><a href="modeling.html#hyperparameter-optimization"><i class="fa fa-check"></i><b>6.4</b> Hyperparameter Optimization</a><ul>
<li class="chapter" data-level="6.4.1" data-path="modeling.html"><a href="modeling.html#creating-our-scoring-function"><i class="fa fa-check"></i><b>6.4.1</b> Creating Our Scoring Function</a></li>
<li class="chapter" data-level="6.4.2" data-path="modeling.html"><a href="modeling.html#parameter-search-space"><i class="fa fa-check"></i><b>6.4.2</b> Parameter Search Space</a></li>
<li class="chapter" data-level="6.4.3" data-path="modeling.html"><a href="modeling.html#fold-cross-validation"><i class="fa fa-check"></i><b>6.4.3</b> 5-fold Cross Validation</a></li>
<li class="chapter" data-level="6.4.4" data-path="modeling.html"><a href="modeling.html#random-forest-search-of-parameter-space"><i class="fa fa-check"></i><b>6.4.4</b> Random Forest Search of Parameter Space</a></li>
<li class="chapter" data-level="6.4.5" data-path="modeling.html"><a href="modeling.html#exploring-parameter-space"><i class="fa fa-check"></i><b>6.4.5</b> Exploring Parameter Space</a></li>
</ul></li>
<li class="chapter" data-level="6.5" data-path="modeling.html"><a href="modeling.html#tuned-model"><i class="fa fa-check"></i><b>6.5</b> Tuned Model</a><ul>
<li class="chapter" data-level="6.5.1" data-path="modeling.html"><a href="modeling.html#making-predictions-with-tuned-model"><i class="fa fa-check"></i><b>6.5.1</b> Making Predictions with Tuned Model</a></li>
</ul></li>
<li class="chapter" data-level="6.6" data-path="modeling.html"><a href="modeling.html#model-comparison"><i class="fa fa-check"></i><b>6.6</b> Model Comparison</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="summary.html"><a href="summary.html"><i class="fa fa-check"></i><b>7</b> Summary</a><ul>
<li class="chapter" data-level="7.1" data-path="summary.html"><a href="summary.html#key-findings"><i class="fa fa-check"></i><b>7.1</b> Key Findings</a></li>
<li class="chapter" data-level="7.2" data-path="summary.html"><a href="summary.html#next-steps"><i class="fa fa-check"></i><b>7.2</b> Next Steps</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">An Example Predictive Modeling Workflow Using The Zillow Prize Dataset</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="preprocessing" class="section level1">
<h1><span class="header-section-number">Chapter 2</span> PreProcessing</h1>
<p>The first step for any data driven project is getting to know the data. In this section we will look at the raw data that was provided by the competition and then do a little pre processing that will make the data easier to work with for the rest of the project</p>
<div id="the-raw-data" class="section level2">
<h2><span class="header-section-number">2.1</span> The Raw Data</h2>
<p>The raw data from zillow contains the following data (desrciptions from the the data page)</p>
<ul>
<li><p><strong>properties_2016.csv</strong> - all the properties with their home features for 2016. Note: Some 2017 new properties don’t have any data yet except for their parcelid’s. Those data points should be populated when properties_2017.csv is available.</p></li>
<li><p><strong>properties_2017.csv</strong> - all the properties with their home features for 2017 (released on 10/2/2017)</p></li>
<li><p><strong>train_2016.csv</strong> - the training set with transactions from 1/1/2016 to 12/31/2016</p></li>
<li><p><strong>train_2017.csv</strong> - the training set with transactions from 1/1/2017 to 9/15/2017 (released on 10/2/2017)</p></li>
<li><p><strong>sample_submission.csv</strong> - a sample submission file in the correct format</p></li>
<li><p><strong>zillow_data_dictionary.xlsx</strong> - Field Definitions and coded value meanings</p></li>
</ul>
<div id="saving-raw-data-using-feather" class="section level3">
<h3><span class="header-section-number">2.1.1</span> Saving Raw Data Using <code>feather</code></h3>
<p>The R binding for the <a href="https://github.com/wesm/feather">feather</a> data store provides the ability for very fast read and write of data. For speed purposes we will save all raw data into a <code>.feather</code> file format to make all other read faster</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(feather)
<span class="kw">library</span>(readr)

<span class="kw">dir.create</span>(<span class="st">&quot;data-raw/feather&quot;</span>)

prop_<span class="dv">16</span> &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">&quot;data-raw/properties_2016.csv&quot;</span>)
prop_<span class="dv">17</span> &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">&quot;data-raw/properties_2017.csv&quot;</span>)
train_<span class="dv">16</span> &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">&quot;data-raw/train_2016_v2.csv&quot;</span>)
train_<span class="dv">17</span> &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">&quot;data-raw/train_2017.csv&quot;</span>)

<span class="kw">write_feather</span>(prop_<span class="dv">16</span>, <span class="st">&quot;data-raw/feather/properties_2016.feather&quot;</span>)
<span class="kw">write_feather</span>(prop_<span class="dv">17</span>, <span class="st">&quot;data-raw/feather/properties_2017.feather&quot;</span>)
<span class="kw">write_feather</span>(train_<span class="dv">16</span>, <span class="st">&quot;data-raw/feather/train_2016_v2.feather&quot;</span>)
<span class="kw">write_feather</span>(train_<span class="dv">17</span>, <span class="st">&quot;data-raw/feather/train_2017.feather&quot;</span>)</code></pre></div>
</div>
</div>
<div id="renaming-variables" class="section level2">
<h2><span class="header-section-number">2.2</span> Renaming Variables</h2>
<p>Many of the feature names are not very consistant. To take advatange of helpful functions from the <code>tidyverse</code> set of packages, such as <code>starts_with()</code> and <code>one_of()</code> Let’s rename them to something more consistant and easier to work with.</p>
<div id="renaming-properties-features" class="section level3">
<h3><span class="header-section-number">2.2.1</span> Renaming <code>properties</code> Features</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(tidyverse)

prop_<span class="dv">16</span> &lt;-<span class="st"> </span><span class="kw">read_feather</span>(<span class="st">&quot;data-raw/feather/properties_2016.feather&quot;</span>)
prop_<span class="dv">17</span> &lt;-<span class="st"> </span><span class="kw">read_feather</span>(<span class="st">&quot;data-raw/feather/properties_2017.feather&quot;</span>)

prop_<span class="dv">16</span> &lt;-<span class="st"> </span>prop_<span class="dv">16</span> <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">rename</span>(
    <span class="dt">id_parcel =</span> parcelid,
    <span class="dt">build_year =</span> yearbuilt,
    <span class="dt">area_basement =</span> basementsqft,
    <span class="dt">area_patio =</span> yardbuildingsqft17,
    <span class="dt">area_shed =</span> yardbuildingsqft26, 
    <span class="dt">area_pool =</span> poolsizesum,  
    <span class="dt">area_lot =</span> lotsizesquarefeet, 
    <span class="dt">area_garage =</span> garagetotalsqft,
    <span class="dt">area_firstfloor_finished_1 =</span> finishedfloor1squarefeet,
    <span class="dt">area_firstfloor_finished_2 =</span> finishedsquarefeet50,
    <span class="dt">area_living_finished_calc =</span> calculatedfinishedsquarefeet,
    <span class="dt">area_base =</span> finishedsquarefeet6,
    <span class="dt">area_living_finished =</span> finishedsquarefeet12,
    <span class="dt">area_living_perimeter =</span> finishedsquarefeet13,
    <span class="dt">area_total =</span> finishedsquarefeet15,  
    <span class="dt">num_unit =</span> unitcnt, 
    <span class="dt">num_story =</span> numberofstories,  
    <span class="dt">num_room =</span> roomcnt,
    <span class="dt">num_bathroom =</span> bathroomcnt,
    <span class="dt">num_bedroom =</span> bedroomcnt,
    <span class="dt">num_bathroom_calc =</span> calculatedbathnbr,
    <span class="dt">num_bath =</span> fullbathcnt,  
    <span class="dt">num_75_bath =</span> threequarterbathnbr, 
    <span class="dt">num_fireplace =</span> fireplacecnt,
    <span class="dt">num_pool =</span> poolcnt,  
    <span class="dt">num_garage =</span> garagecarcnt,  
    <span class="dt">region_county =</span> regionidcounty,
    <span class="dt">region_city =</span> regionidcity,
    <span class="dt">region_zip =</span> regionidzip,
    <span class="dt">region_neighbor =</span> regionidneighborhood,  
    <span class="dt">tax_total =</span> taxvaluedollarcnt,
    <span class="dt">tax_building =</span> structuretaxvaluedollarcnt,
    <span class="dt">tax_land =</span> landtaxvaluedollarcnt,
    <span class="dt">tax_property =</span> taxamount,
    <span class="dt">tax_year =</span> assessmentyear,
    <span class="dt">tax_delinquency =</span> taxdelinquencyflag,
    <span class="dt">tax_delinquency_year =</span> taxdelinquencyyear,
    <span class="dt">zoning_property =</span> propertyzoningdesc,
    <span class="dt">zoning_landuse =</span> propertylandusetypeid,
    <span class="dt">zoning_landuse_county =</span> propertycountylandusecode,
    <span class="dt">str_flag_fireplace =</span> fireplaceflag, 
    <span class="dt">str_flag_tub =</span> hashottuborspa,
    <span class="dt">str_quality =</span> buildingqualitytypeid,
    <span class="dt">str_framing =</span> buildingclasstypeid,
    <span class="dt">str_material =</span> typeconstructiontypeid,
    <span class="dt">str_deck =</span> decktypeid,
    <span class="dt">str_story =</span> storytypeid,
    <span class="dt">str_heating =</span> heatingorsystemtypeid,
    <span class="dt">str_aircon =</span> airconditioningtypeid,
    <span class="dt">str_arch_style =</span> architecturalstyletypeid
  )

<span class="co"># use 2016 names to rename 17</span>
<span class="kw">names</span>(prop_<span class="dv">17</span>) &lt;-<span class="st"> </span><span class="kw">names</span>(prop_<span class="dv">16</span>)</code></pre></div>
</div>
<div id="renaming-train-features" class="section level3">
<h3><span class="header-section-number">2.2.2</span> renaming <code>train</code> features</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">trans_<span class="dv">16</span> &lt;-<span class="st"> </span><span class="kw">read_feather</span>(<span class="st">&quot;data-raw/feather/train_2016_v2.feather&quot;</span>)
trans_<span class="dv">17</span> &lt;-<span class="st"> </span><span class="kw">read_feather</span>(<span class="st">&quot;data-raw/feather/train_2017.feather&quot;</span>)

trans_<span class="dv">16</span> &lt;-<span class="st"> </span>trans_<span class="dv">16</span> <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">rename</span>(
  <span class="dt">id_parcel =</span> parcelid,
  <span class="dt">date =</span> transactiondate,
  <span class="dt">log_error =</span> logerror
  )

<span class="co"># use 2016 names to rename 17</span>
<span class="kw">names</span>(trans_<span class="dv">17</span>) &lt;-<span class="st"> </span><span class="kw">names</span>(trans_<span class="dv">16</span>)</code></pre></div>
</div>
<div id="basic-transformations" class="section level3">
<h3><span class="header-section-number">2.2.3</span> Basic Transformations</h3>
<p>Based on the definitions in the <code>zillow_data_dictionary.xlsx</code> we can recode some of the features to have be more interpretable while we are exploring.</p>
<div id="properties" class="section level4">
<h4><span class="header-section-number">2.2.3.1</span> Properties</h4>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(forcats)

prop_<span class="dv">16</span> &lt;-<span class="st"> </span>prop_<span class="dv">16</span> <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(
    <span class="dt">tax_delinquency =</span> <span class="kw">ifelse</span>(tax_delinquency <span class="op">==</span><span class="st"> &quot;Y&quot;</span>, <span class="st">&quot;Yes&quot;</span>, <span class="st">&quot;No&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">as_factor</span>(),
    <span class="dt">str_flag_fireplace =</span> <span class="kw">ifelse</span>(str_flag_fireplace <span class="op">==</span><span class="st"> &quot;Y&quot;</span>, <span class="st">&quot;Yes&quot;</span>, <span class="st">&quot;No&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">as_factor</span>(),
    <span class="dt">str_flag_tub =</span> <span class="kw">ifelse</span>(str_flag_tub <span class="op">==</span><span class="st"> &quot;Y&quot;</span>, <span class="st">&quot;Yes&quot;</span>, <span class="st">&quot;No&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">as_factor</span>(),
    <span class="dt">zoning_landuse =</span> <span class="kw">factor</span>(zoning_landuse, <span class="dt">levels =</span> <span class="kw">sort</span>(<span class="kw">unique</span>(zoning_landuse))),
    <span class="dt">zoning_landuse =</span> <span class="kw">fct_recode</span>(zoning_landuse,
      <span class="st">&quot;Commercial/Office/Residential Mixed Used&quot;</span> =<span class="st"> &quot;31&quot;</span>, 
      <span class="st">&quot;Multi-Story Store&quot;</span>                        =<span class="st"> &quot;46&quot;</span>,
      <span class="st">&quot;Store/Office (Mixed Use)&quot;</span>                 =<span class="st"> &quot;47&quot;</span>,
      <span class="st">&quot;Duplex (2 Units Any Combination)&quot;</span>         =<span class="st"> &quot;246&quot;</span>,
      <span class="st">&quot;Triplex (3 Units Any Combination)&quot;</span>        =<span class="st"> &quot;247&quot;</span>,
      <span class="st">&quot;Quadruplex (4 Units Any Combination)&quot;</span>     =<span class="st"> &quot;248&quot;</span>,
      <span class="st">&quot;Residential General&quot;</span>                      =<span class="st"> &quot;260&quot;</span>,
      <span class="st">&quot;Single Family Residential&quot;</span>                =<span class="st"> &quot;261&quot;</span>,
      <span class="st">&quot;Rural Residence&quot;</span>                          =<span class="st"> &quot;262&quot;</span>,
      <span class="st">&quot;Mobile Home&quot;</span>                              =<span class="st"> &quot;263&quot;</span>,
      <span class="st">&quot;Townhouse&quot;</span>                                =<span class="st"> &quot;264&quot;</span>,
      <span class="st">&quot;Cluster Home&quot;</span>                             =<span class="st"> &quot;265&quot;</span>,
      <span class="st">&quot;Condominium&quot;</span>                              =<span class="st"> &quot;266&quot;</span>,
      <span class="st">&quot;Cooperative&quot;</span>                              =<span class="st"> &quot;267&quot;</span>,
      <span class="st">&quot;Row House&quot;</span>                                =<span class="st"> &quot;268&quot;</span>,
      <span class="st">&quot;Planned Unit Development&quot;</span>                 =<span class="st"> &quot;269&quot;</span>,
      <span class="st">&quot;Residential Common Area&quot;</span>                  =<span class="st"> &quot;270&quot;</span>,
      <span class="st">&quot;Timeshare&quot;</span>                                =<span class="st"> &quot;271&quot;</span>,
      <span class="st">&quot;Bungalow&quot;</span>                                 =<span class="st"> &quot;273&quot;</span>,
      <span class="st">&quot;Zero Lot Line&quot;</span>                            =<span class="st"> &quot;274&quot;</span>,
      <span class="st">&quot;Manufactured Modular Prefabricated Homes&quot;</span> =<span class="st"> &quot;275&quot;</span>,
      <span class="st">&quot;Patio Home&quot;</span>                               =<span class="st"> &quot;276&quot;</span>,
      <span class="st">&quot;Inferred Single Family Residential&quot;</span>       =<span class="st"> &quot;279&quot;</span>,
      <span class="st">&quot;Vacant Land - General&quot;</span>                    =<span class="st"> &quot;290&quot;</span>,
      <span class="st">&quot;Residential Vacant Land&quot;</span>                  =<span class="st"> &quot;291&quot;</span>
      )
    )

prop_<span class="dv">17</span> &lt;-<span class="st"> </span>prop_<span class="dv">17</span> <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(
    <span class="dt">tax_delinquency =</span> <span class="kw">ifelse</span>(tax_delinquency <span class="op">==</span><span class="st"> &quot;Y&quot;</span>, <span class="st">&quot;Yes&quot;</span>, <span class="st">&quot;No&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">as_factor</span>(),
    <span class="dt">str_flag_fireplace =</span> <span class="kw">ifelse</span>(str_flag_fireplace <span class="op">==</span><span class="st"> &quot;Y&quot;</span>, <span class="st">&quot;Yes&quot;</span>, <span class="st">&quot;No&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">as_factor</span>(),
    <span class="dt">str_flag_tub =</span> <span class="kw">ifelse</span>(str_flag_tub <span class="op">==</span><span class="st"> &quot;Y&quot;</span>, <span class="st">&quot;Yes&quot;</span>, <span class="st">&quot;No&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">as_factor</span>(),
    <span class="dt">zoning_landuse =</span> <span class="kw">factor</span>(zoning_landuse, <span class="dt">levels =</span> <span class="kw">sort</span>(<span class="kw">unique</span>(zoning_landuse))),
    <span class="dt">zoning_landuse =</span> <span class="kw">fct_recode</span>(zoning_landuse,
      <span class="st">&quot;Commercial/Office/Residential Mixed Used&quot;</span> =<span class="st"> &quot;31&quot;</span>, 
      <span class="st">&quot;Multi-Story Store&quot;</span>                        =<span class="st"> &quot;46&quot;</span>,
      <span class="st">&quot;Store/Office (Mixed Use)&quot;</span>                 =<span class="st"> &quot;47&quot;</span>,
      <span class="st">&quot;Duplex (2 Units Any Combination)&quot;</span>         =<span class="st"> &quot;246&quot;</span>,
      <span class="st">&quot;Triplex (3 Units Any Combination)&quot;</span>        =<span class="st"> &quot;247&quot;</span>,
      <span class="st">&quot;Quadruplex (4 Units Any Combination)&quot;</span>     =<span class="st"> &quot;248&quot;</span>,
      <span class="st">&quot;Residential General&quot;</span>                      =<span class="st"> &quot;260&quot;</span>,
      <span class="st">&quot;Single Family Residential&quot;</span>                =<span class="st"> &quot;261&quot;</span>,
      <span class="st">&quot;Rural Residence&quot;</span>                          =<span class="st"> &quot;262&quot;</span>,
      <span class="st">&quot;Mobile Home&quot;</span>                              =<span class="st"> &quot;263&quot;</span>,
      <span class="st">&quot;Townhouse&quot;</span>                                =<span class="st"> &quot;264&quot;</span>,
      <span class="st">&quot;Cluster Home&quot;</span>                             =<span class="st"> &quot;265&quot;</span>,
      <span class="st">&quot;Condominium&quot;</span>                              =<span class="st"> &quot;266&quot;</span>,
      <span class="st">&quot;Cooperative&quot;</span>                              =<span class="st"> &quot;267&quot;</span>,
      <span class="st">&quot;Row House&quot;</span>                                =<span class="st"> &quot;268&quot;</span>,
      <span class="st">&quot;Planned Unit Development&quot;</span>                 =<span class="st"> &quot;269&quot;</span>,
      <span class="st">&quot;Residential Common Area&quot;</span>                  =<span class="st"> &quot;270&quot;</span>,
      <span class="st">&quot;Timeshare&quot;</span>                                =<span class="st"> &quot;271&quot;</span>,
      <span class="st">&quot;Bungalow&quot;</span>                                 =<span class="st"> &quot;273&quot;</span>,
      <span class="st">&quot;Zero Lot Line&quot;</span>                            =<span class="st"> &quot;274&quot;</span>,
      <span class="st">&quot;Manufactured Modular Prefabricated Homes&quot;</span> =<span class="st"> &quot;275&quot;</span>,
      <span class="st">&quot;Patio Home&quot;</span>                               =<span class="st"> &quot;276&quot;</span>,
      <span class="st">&quot;Inferred Single Family Residential&quot;</span>       =<span class="st"> &quot;279&quot;</span>,
      <span class="st">&quot;Vacant Land - General&quot;</span>                    =<span class="st"> &quot;290&quot;</span>,
      <span class="st">&quot;Residential Vacant Land&quot;</span>                  =<span class="st"> &quot;291&quot;</span>
      )
    )</code></pre></div>
</div>
<div id="transactions" class="section level4">
<h4><span class="header-section-number">2.2.3.2</span> Transactions</h4>
<p>The transactions tables are where our response variable <code>log_error</code> (name changed from orginal <code>logerror</code>) and the dates of the transactions are recorded.</p>
<p>To make them easier to work with, let’s combine all the transactions into one table and create a few basic transformations of the <code>date</code> (name changed from original <code>transactiondate</code>)</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(lubridate)

<span class="co"># combine transactions into one data frame</span>
trans &lt;-<span class="st"> </span>trans_<span class="dv">16</span> <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">bind_rows</span>(trans_<span class="dv">17</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(
    <span class="dt">abs_log_error =</span> <span class="kw">abs</span>(log_error),
    <span class="dt">year =</span> <span class="kw">year</span>(date),
    <span class="dt">month_year =</span> <span class="kw">make_date</span>(<span class="kw">year</span>(date), <span class="kw">month</span>(date)),
    <span class="dt">month =</span> <span class="kw">month</span>(date, <span class="dt">label =</span> <span class="ot">TRUE</span>),
    <span class="dt">week =</span> <span class="kw">floor_date</span>(date, <span class="dt">unit =</span> <span class="st">&quot;week&quot;</span>),
    <span class="dt">week_of_year =</span> <span class="kw">week</span>(date),
    <span class="dt">week_since_start =</span> (<span class="kw">min</span>(date) <span class="op">%--%</span><span class="st"> </span>date <span class="op">%/%</span><span class="st"> </span><span class="kw">dweeks</span>()) <span class="op">+</span><span class="st"> </span><span class="dv">1</span>,
    <span class="dt">wday =</span> <span class="kw">wday</span>(date, <span class="dt">label =</span> <span class="ot">TRUE</span>),
    <span class="dt">day_of_month =</span> <span class="kw">day</span>(date)
  )</code></pre></div>
<p>Save our output</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">write_feather</span>(prop_<span class="dv">16</span>, <span class="st">&quot;data/properties_16.feather&quot;</span>)
<span class="kw">write_feather</span>(prop_<span class="dv">17</span>, <span class="st">&quot;data/properties_17.feather&quot;</span>)
<span class="kw">write_feather</span>(trans, <span class="st">&quot;data/transactions.feather&quot;</span>)</code></pre></div>
</div>
</div>
</div>
<div id="extracting-geographic-information" class="section level2">
<h2><span class="header-section-number">2.3</span> Extracting Geographic Information</h2>
<p>As noted in the <a href="intro.html#intro">1</a> we are going to break from the rules of the competition and use external information to (hopefully) help improve our predictions. Since the data we are using relate to locations of individual properties and we have each of their geographic coordinates, <code>latitude</code> and <code>longitude</code> let’s use those to get the U.S. Census Geographies they are apart of that we can make use of when adding external information.</p>
<p>The original data contain the fields <code>rawcensustractandblock</code> and <code>censustractandblock</code> but after trying to parse those into a usable format and failing, I figured it was just easier to use the <code>latitude</code> and <code>longitude</code> fields and then join that to the Census information.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(sf)
<span class="kw">library</span>(tidycensus)

<span class="co"># NAD83 / California zone 5 (ftUS)</span>
<span class="co"># https://epsg.io/2229</span>
crs_id &lt;-<span class="st"> </span><span class="dv">2229</span>

api_key &lt;-<span class="st"> </span><span class="kw">Sys.getenv</span>(<span class="st">&quot;CENSUS_API_KEY&quot;</span>)
<span class="kw">census_api_key</span>(api_key)

<span class="co"># some obs have no data at all included lat/long</span>
<span class="co"># the original lat / lon are mulitpled by 10e5 so divide to</span>
<span class="co"># get lat lon back when converting to sf</span>
properties &lt;-<span class="st"> </span><span class="kw">read_feather</span>(<span class="st">&quot;data-raw/properties_2017&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(latitude)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(
    <span class="dt">lat =</span> latitude <span class="op">/</span><span class="st"> </span><span class="fl">10e5</span>,
    <span class="dt">lon =</span> longitude <span class="op">/</span><span class="st"> </span><span class="fl">10e5</span>
    ) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">st_as_sf</span>(
    <span class="dt">coords =</span> <span class="kw">c</span>(<span class="st">&quot;lon&quot;</span>, <span class="st">&quot;lat&quot;</span>), 
    <span class="dt">crs =</span> <span class="dv">4326</span>, <span class="co"># WGS 84</span>
    <span class="dt">remove =</span> <span class="ot">FALSE</span> <span class="co"># keep lat/long fields</span>
    ) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">st_transform</span>(crs_id)

census_bgs &lt;-<span class="st"> </span><span class="kw">get_acs</span>(
  <span class="dt">geography =</span> <span class="st">&quot;block group&quot;</span>, 
  <span class="dt">variables =</span> <span class="st">&quot;B19013_001&quot;</span>, 
  <span class="dt">state =</span> <span class="st">&quot;CA&quot;</span>,
  <span class="dt">county =</span> <span class="kw">c</span>(<span class="st">&quot;Los Angeles&quot;</span>, <span class="st">&quot;Orange&quot;</span>, <span class="st">&quot;Ventura&quot;</span>), 
  <span class="dt">geometry =</span> <span class="ot">TRUE</span>, 
  <span class="dt">keep_geo_vars =</span> <span class="ot">TRUE</span>
  ) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">st_transform</span>(crs_id)

<span class="co"># inner join</span>
<span class="co"># due to lat / lon error some points didn&#39;t intersect</span>
<span class="co"># with block groups left = FALSE is inner join</span>
properties_geo &lt;-<span class="st"> </span>properties <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">st_join</span>(census_bgs, <span class="dt">left =</span> <span class="ot">FALSE</span>)

<span class="co"># find all of the points that didn&#39;t intersect</span>
<span class="co"># buffer them and then join to closest block</span>
<span class="co"># then add back the already joined points</span>
<span class="co"># the buffer distance I just played around with until</span>
<span class="co"># all points joined with a block group</span>
properties_geo &lt;-<span class="st"> </span>properties <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span>parcelid <span class="op">%in%</span><span class="st"> </span>properties_geo<span class="op">$</span>parcelid) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">st_buffer</span>(<span class="dt">dist =</span> <span class="dv">1500</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># units are in us-ft based on crs_id</span>
<span class="st">  </span><span class="kw">st_join</span>(census_bgs, <span class="dt">left =</span> <span class="ot">FALSE</span>, <span class="dt">largest =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">rbind</span>(properties_geo)


<span class="co"># remove geometry b/c feather can&#39;t store lists</span>
properties_geo &lt;-<span class="st"> </span>properties_geo <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(
    <span class="dt">id_parcel =</span> parcelid,
    <span class="dt">id_geo_state =</span> STATEFP,
    <span class="dt">id_geo_county =</span> COUNTYFP,
    <span class="dt">id_geo_tract =</span> TRACTCE,
    <span class="dt">id_geo_bg =</span> BLKGRPCE,
    <span class="dt">id_geo_bg_fips =</span> GEOID,
    <span class="dt">id_geo_bg_name =</span> NAME.y,
    <span class="dt">geo_bg_arealand =</span> ALAND,
    <span class="dt">geo_bg_areawater =</span> AWATER,
    lat, 
    lon
    ) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(
    <span class="dt">id_geo_county_fips =</span> <span class="kw">paste0</span>(id_geo_state, id_geo_county),
    <span class="dt">id_geo_tract_fips =</span> <span class="kw">paste0</span>(id_geo_county_fips, id_geo_tract),
    <span class="dt">id_geo_county_name =</span> <span class="kw">factor</span>(id_geo_county) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">fct_recode</span>(
        <span class="st">&quot;Los Angeles&quot;</span> =<span class="st"> &quot;037&quot;</span>,
        <span class="st">&quot;Orange&quot;</span>      =<span class="st"> &quot;059&quot;</span>,
        <span class="st">&quot;Ventura&quot;</span>     =<span class="st"> &quot;111&quot;</span>
      )
  )</code></pre></div>
<p>Now save our geographic features</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># remove geometry b/c feather can&#39;t store lists</span>
<span class="co"># add back in when needed from lat lon</span>
properties_geo<span class="op">$</span>geometry &lt;-<span class="st"> </span><span class="ot">NULL</span>

<span class="kw">write_feather</span>(properties_geo, <span class="st">&quot;data/properties_geo_only.feather&quot;</span>)</code></pre></div>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="intro.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="eda.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"linkedin": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"download": ["zillow-prize.pdf", "zillow-prize.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "";
    if (src === "" || src === "true") src = "https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(src))
      src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
